# AI模块手动测试指南

本文档提供AI模块的手动测试步骤，帮助您收集测试证据并填写测试报告。

## 准备工作

### 1. 环境配置检查

```bash
# 检查环境变量是否配置
echo $DEEPSEEK_API_KEY

# 如果没有配置，设置环境变量（Windows PowerShell）
$env:DEEPSEEK_API_KEY = "your_api_key_here"

# 如果没有配置，设置环境变量（Linux/Mac）
export DEEPSEEK_API_KEY="your_api_key_here"
```

### 2. 启动应用

确保Calibre-Web应用正在运行：
```bash
python cps.py
```

### 3. 准备测试工具

- **浏览器**：Chrome/Firefox/Safari（建议使用Chrome开发者工具）
- **API测试工具**：Postman 或 curl
- **截图工具**：用于保存测试证据

---

## 测试步骤

### 测试1：AI摘要生成功能（TC-001）

#### 步骤：
1. 打开浏览器，访问 `http://localhost:8083`（根据实际端口调整）
2. 登录系统（使用测试账号）
3. 浏览书籍列表，选择一本书（建议选择ID为42的书籍）
4. 进入书籍详情页面（URL类似：`/book/42`）
5. 滚动到"AI 助手"区块
6. 点击"生成 AI 概述"按钮
7. 观察页面变化

#### 预期结果：
- ✅ 点击按钮后，显示"AI 正在思考，请稍候…"加载提示
- ✅ 等待10-30秒后，在`#ai-summary-result`区域显示AI生成的摘要
- ✅ 摘要内容为3-5段中文文字
- ✅ 摘要内容与书籍信息相关

#### 截图要求：
- 截图1：点击按钮前的页面状态
- 截图2：加载中的状态（显示"AI 正在思考"）
- 截图3：显示摘要结果的状态

#### 记录信息：
- 响应时间：从点击按钮到显示结果的时间
- 摘要内容长度：字符数
- 摘要内容预览：前100个字符

---

### 测试2：AI推荐功能（TC-003）

#### 步骤：
1. 在同一书籍详情页面
2. 点击"推荐相关书籍"按钮
3. 观察页面变化

#### 预期结果：
- ✅ 点击按钮后，显示加载提示
- ✅ 等待后，在`#ai-related-result`区域显示推荐列表
- ✅ 推荐列表包含5本相关书籍
- ✅ 每本推荐包含书名、作者和推荐理由

#### 截图要求：
- 截图1：点击按钮前的页面状态
- 截图2：显示推荐结果的状态

#### 记录信息：
- 响应时间：从点击按钮到显示结果的时间
- 推荐数量：实际推荐的书籍数量
- 推荐内容预览：前200个字符

---

### 测试3：API端点直接测试（TC-004, TC-005）

#### 使用curl测试：

```bash
# 测试摘要API（需要先登录获取cookie）
curl -X GET "http://localhost:8083/ajax/ai/book_summary/42" \
  -H "Cookie: session=your_session_cookie" \
  -v

# 测试推荐API
curl -X GET "http://localhost:8083/ajax/ai/book_recommendations/42" \
  -H "Cookie: session=your_session_cookie" \
  -v

# 测试不存在的书籍ID
curl -X GET "http://localhost:8083/ajax/ai/book_summary/99999" \
  -H "Cookie: session=your_session_cookie" \
  -v
```

#### 使用Postman测试：

1. 创建新请求
2. 方法：GET
3. URL：`http://localhost:8083/ajax/ai/book_summary/42`
4. Headers：添加Cookie（需要先登录获取）
5. 发送请求

#### 预期结果：

| 测试场景 | 预期HTTP状态码 | 预期响应格式 |
|----------|----------------|--------------|
| 正常请求 | 200 | `{"content": "..."}` |
| 书籍不存在 | 404 | `{"error": "book_not_found"}` |
| 未登录 | 302/401 | 重定向或错误 |

#### 记录信息：
- 每个请求的HTTP状态码
- 响应体内容（保存JSON响应）
- 响应时间

---

### 测试4：错误场景测试（TC-006, TC-007）

#### 测试API密钥未配置：

1. 停止应用
2. 移除或清空`DEEPSEEK_API_KEY`环境变量
3. 重启应用
4. 尝试生成AI摘要

#### 预期结果：
- ✅ 返回500错误
- ✅ 响应包含：`{"error": "ai_failed", "detail": "..."}`
- ✅ 前端显示错误提示："AI 调用失败: ai_failed"

#### 测试API密钥无效：

1. 设置无效的API密钥：`export DEEPSEEK_API_KEY="invalid_key"`
2. 重启应用
3. 尝试生成AI摘要

#### 预期结果：
- ✅ 返回500错误
- ✅ 响应包含错误详情
- ✅ 前端显示错误提示

#### 记录信息：
- 错误响应内容
- 前端错误提示截图
- 后端日志错误信息

---

### 测试5：不同书籍测试（TC-002）

#### 测试多个书籍：

选择以下书籍进行测试：

| 书籍ID | 书名 | 预期结果 |
|--------|------|----------|
| 42 | The Adventures of Sherlock Holmes | ☐ 通过 ☐ 失败 |
| 52 | Dracula | ☐ 通过 ☐ 失败 |
| 51 | A Tale of Two Cities | ☐ 通过 ☐ 失败 |
| 45 | Jane Eyre | ☐ 通过 ☐ 失败 |

#### 记录信息：
- 每个书籍的测试结果
- 每个书籍的响应时间
- 摘要内容质量评估

---

### 测试6：性能测试（TC-014）

#### 步骤：
1. 选择一本书籍（如ID=42）
2. 连续5次点击"生成 AI 概述"按钮
3. 记录每次的响应时间

#### 记录表格：

| 测试次数 | 响应时间（秒） | 是否成功 |
|----------|----------------|----------|
| 1 | _____ | ☐ 是 ☐ 否 |
| 2 | _____ | ☐ 是 ☐ 否 |
| 3 | _____ | ☐ 是 ☐ 否 |
| 4 | _____ | ☐ 是 ☐ 否 |
| 5 | _____ | ☐ 是 ☐ 否 |

#### 计算：
- 平均响应时间：_____秒
- 最大响应时间：_____秒
- 最小响应时间：_____秒

#### 性能标准：
- ✅ 平均响应时间 < 30秒
- ✅ 最大响应时间 < 40秒（超时限制）

---

### 测试7：前端UI测试（TC-012, TC-013）

#### 检查项：

- [ ] AI功能区块在书籍详情页可见
- [ ] "生成 AI 概述"按钮可见且可点击
- [ ] "推荐相关书籍"按钮可见且可点击
- [ ] 点击按钮后显示加载提示
- [ ] 加载提示在响应完成后自动隐藏
- [ ] 结果显示在正确的区域
- [ ] 错误信息清晰显示
- [ ] 页面布局正常，无样式问题

#### 截图要求：
- 完整页面截图（包含AI功能区块）
- 加载状态截图
- 结果显示截图
- 错误状态截图（如果有）

---

### 测试8：日志检查（TC-017）

#### 步骤：
1. 查看应用日志文件（通常是`calibre-web.log`）
2. 执行一些AI功能操作
3. 检查日志中的相关记录

#### 检查项：

- [ ] 成功请求有日志记录
- [ ] 错误请求有详细的错误日志
- [ ] 日志包含足够的调试信息（书籍ID、错误类型等）
- [ ] 日志格式清晰易读

#### 记录信息：
- 成功请求日志示例（复制几行）
- 错误请求日志示例（如果有）
- 日志文件路径

---

## 测试证据收集清单

### 截图证据：
- [ ] 功能正常截图（AI摘要生成）
- [ ] 功能正常截图（AI推荐生成）
- [ ] 加载状态截图
- [ ] 错误场景截图
- [ ] 前端UI完整截图

### 日志证据：
- [ ] 成功请求日志（复制到文档）
- [ ] 错误请求日志（如果有，复制到文档）
- [ ] 性能测试日志

### API测试证据：
- [ ] Postman测试结果（导出为JSON）
- [ ] curl测试结果（保存输出）
- [ ] API响应示例（保存JSON）

### 数据记录：
- [ ] 响应时间数据
- [ ] 测试用例执行结果表格
- [ ] 缺陷记录（如果有）

---

## 填写测试报告

完成所有测试后，请按照以下步骤填写`AI_MODULE_TEST_REPORT.md`：

1. **填写测试概述**：日期、测试人员、环境信息
2. **填写测试结果**：在每个测试用例的"实际结果"处打勾
3. **填写测试证据**：在"测试证据"处填写截图路径、日志位置等
4. **统计测试结果**：计算通过率
5. **填写测试结论**：给出最终评价和建议

---

## 常见问题

### Q: API请求返回401/403错误？
A: 检查是否已登录，需要先登录获取session cookie。

### Q: API请求超时？
A: 检查网络连接和DeepSeek API是否可访问，检查API密钥是否有效。

### Q: 前端按钮点击无反应？
A: 检查浏览器控制台是否有JavaScript错误，检查`ai.js`文件是否加载。

### Q: 如何获取session cookie？
A: 登录后，在浏览器开发者工具的Application/Storage标签页中查看Cookies。

---

## 测试完成检查

在提交测试报告前，请确认：

- [ ] 所有测试用例都已执行
- [ ] 所有测试结果都已记录
- [ ] 所有截图都已保存并标注
- [ ] 所有日志都已收集
- [ ] 测试报告已完整填写
- [ ] 测试证据已整理归档

---

**测试完成后，请将测试报告和所有证据文件一起提交。**

